# Interspect

åŸºäº NestJS 11.x æ„å»ºçš„ **API äº¤äº’åè®®åˆ†æå·¥å…·**ï¼Œé€šè¿‡é€æ˜ä»£ç†çš„æ–¹å¼æˆªå–å’Œç›‘æ§ HTTP/HTTPS è¯·æ±‚ä¸ WebSocket æ¶ˆæ¯ï¼Œæä¾›å®æ—¶çš„åè®®åˆ†æå’Œè°ƒè¯•åŠŸèƒ½ã€‚

### ç•Œé¢é¢„è§ˆ

#### å®æ—¶åè®®ç›‘æ§ç•Œé¢
![å®æ—¶åè®®ç›‘æ§](./scripts/ScreenShot-1.png)

#### è¯¦ç»†æ—¥å¿—åˆ†æç•Œé¢
![è¯¦ç»†æ—¥å¿—åˆ†æ](./scripts/ScreenShot-2.png)

## æ ¸å¿ƒåŠŸèƒ½

- ğŸ” **åè®®æˆªå–** - é€æ˜ä»£ç† HTTP/HTTPS è¯·æ±‚ï¼Œå®Œæ•´è®°å½•è¯·æ±‚å¤´ã€å‚æ•°ã€å“åº”å†…å®¹
- ğŸ“¡ **æ¶ˆæ¯ç›‘æ§** - å®æ—¶æ•è· WebSocket åŒå‘æ¶ˆæ¯æµï¼Œæ”¯æŒæ–‡æœ¬å’ŒäºŒè¿›åˆ¶æ•°æ®
- ğŸ“Š **æ€§èƒ½åˆ†æ** - è¯·æ±‚è€—æ—¶ã€çŠ¶æ€ç åˆ†å¸ƒã€è¿æ¥æ± çŠ¶æ€ç­‰æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡
- ğŸ“± **å®æ—¶ä»ªè¡¨ç›˜** - åŸºäº Server-Sent Events çš„å®æ—¶ç›‘æ§ç•Œé¢ï¼Œæ”¯æŒæ—¥å¿—è¿‡æ»¤å’Œåˆ†æ
- ğŸ—ƒï¸ **æ•°æ®æŒä¹…åŒ–** - å®Œæ•´çš„è¯·æ±‚/å“åº”æ—¥å¿—è®°å½•ï¼Œæ”¯æŒå‹ç¼©å­˜å‚¨å’Œå›æ”¾

## æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: NestJS 11.x
- **è¯­è¨€**: TypeScript 5.9.2
- **è¿è¡Œæ—¶**: Node.js
- **æµ‹è¯•**: Jest
- **ä»£ç è§„èŒƒ**: ESLint + Prettier
- **HTTP ä»£ç†**: http-proxy
- **WebSocket**: ws

## å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
npm install
```

### å¼€å‘ç¯å¢ƒå¯åŠ¨

```bash
# å¸¦æ–‡ä»¶ç›‘å¬çš„å¼€å‘æ¨¡å¼
npm run start:dev

# å¸¦è°ƒè¯•æ¨¡å¼çš„å¼€å‘ç¯å¢ƒ
npm run start:debug
```

### ç”Ÿäº§æ„å»ºå’Œè¿è¡Œ

```bash
# æ„å»ºé¡¹ç›®
npm run build

# ç”Ÿäº§ç¯å¢ƒè¿è¡Œ
npm run start:prod
```

## é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ proxy-module/         # ä»£ç†æœåŠ¡æ ¸å¿ƒ
â”‚   â”œâ”€â”€ services/         # HttpProxy å’Œ WebSocketGateway
â”‚   â””â”€â”€ proxy.module.ts   # ä»£ç†æ¨¡å—é…ç½®
â”œâ”€â”€ inspect-module/       # è¯·æ±‚ç›‘æ§æ¨¡å—
â”‚   â”œâ”€â”€ services/         # æ—¥å¿—ã€SSE å’ŒæŒ‡æ ‡æœåŠ¡
â”‚   â””â”€â”€ inspect.module.ts # ç›‘æ§æ¨¡å—é…ç½®
â”œâ”€â”€ common/              # å…¬å…±æ¨¡å—
â”‚   â”œâ”€â”€ bootstrap/        # åº”ç”¨å¯åŠ¨åˆå§‹åŒ–é€»è¾‘
â”‚   â”œâ”€â”€ filters/          # å¼‚å¸¸è¿‡æ»¤å™¨
â”‚   â””â”€â”€ utils/            # å·¥å…·ç±»
â”œâ”€â”€ app.module.ts        # åº”ç”¨ä¸»æ¨¡å—
â”œâ”€â”€ app.controller.ts    # åº”ç”¨æ§åˆ¶å™¨
â””â”€â”€ app.service.ts       # åº”ç”¨æœåŠ¡
```

## æ ¸å¿ƒæ¨¡å—

### ä»£ç†æœåŠ¡ (Proxy Module)

- **HttpProxy**: åŸºäº http-proxy åº“çš„ HTTP/HTTPS ä»£ç†å®ç°
- **WebSocketGateway**: åŸºäº ws åº“çš„ WebSocket ç½‘å…³ï¼ˆä¸€å¯¹ä¸€ä»£ç†ï¼‰
- **è¿æ¥æ± ç®¡ç†**: ç‹¬ç«‹çš„ HTTP/HTTPS Agentï¼Œç¦ç”¨è¿æ¥å¤ç”¨é¿å… socket hang up
- **æ€§èƒ½æŒ‡æ ‡**: å®æ—¶æ”¶é›†è¯·æ±‚ç»Ÿè®¡å’Œè¿æ¥æ± æŒ‡æ ‡

### ç›‘æ§æœåŠ¡ (Inspect Module)

- **InspectService**: å®Œæ•´çš„åè®®æˆªå–æœåŠ¡ï¼Œæ”¯æŒ HTTP è¯·æ±‚/å“åº”å’Œ WebSocket æ¶ˆæ¯çš„è¯¦ç»†è®°å½•
- **SseService**: Server-Sent Events å®æ—¶æ¨é€æœåŠ¡ï¼Œå¸¦å¿ƒè·³æ£€æµ‹å’Œå®¢æˆ·ç«¯ç®¡ç†
- **ProxyMetricsService**: HTTP ä»£ç†æ€§èƒ½æŒ‡æ ‡ç»Ÿè®¡ï¼ŒåŒ…æ‹¬è¯·æ±‚é‡ã€çŠ¶æ€ç åˆ†å¸ƒã€å“åº”æ—¶é—´ç­‰
- **AgentMetricsService**: è¿æ¥æ± çŠ¶æ€ç›‘æ§ï¼Œå®æ—¶è·Ÿè¸ª sockets æ•°é‡å’Œå¾…å¤„ç†è¯·æ±‚

### Bootstrap åˆå§‹åŒ–

**common/bootstrap/** ç›®å½•åŒ…å«åº”ç”¨å¯åŠ¨æ—¶çš„åˆå§‹åŒ–é€»è¾‘ï¼š
- **filters.setup.ts**: å…¨å±€å¼‚å¸¸è¿‡æ»¤å™¨é…ç½®
- **http-proxy.setup.ts**: HTTP ä»£ç†è·¯ç”±é…ç½®
- **websocket-proxy.setup.ts**: WebSocket ç½‘å…³é…ç½®
- **static-assets.setup.ts**: é™æ€èµ„æºé…ç½®ï¼ˆ`/interspect/web` è·¯å¾„ï¼‰

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

```bash
TARGET_SERVER_URL=http://localhost:3000  # ç›®æ ‡æœåŠ¡å™¨ URLï¼ˆå¿…éœ€é…ç½®ï¼‰
PORT=3000                               # æœåŠ¡ç«¯å£ï¼ˆé»˜è®¤ 3000ï¼‰
```

### ä»£ç†é…ç½®

HTTP ä»£ç†æ”¯æŒä»¥ä¸‹é…ç½®ï¼š
- è¶…æ—¶æ—¶é—´: 120 ç§’
- æœ€å¤§è¿æ¥æ•°: Infinity
- æœ€å¤§ç©ºé—²è¿æ¥: 0
- ç¦ç”¨è¿æ¥å¤ç”¨ (é¿å… socket hang up)

### WebSocket é…ç½®

- **é€æ˜ä»£ç†**: ä¸€å¯¹ä¸€åŒå‘æ¶ˆæ¯ä»£ç†ï¼Œå®Œæ•´è®°å½•æ¶ˆæ¯æµå‘
- **æ•°æ®ç±»å‹**: æ”¯æŒæ–‡æœ¬å’ŒäºŒè¿›åˆ¶æ•°æ®çš„æˆªå–ä¸åˆ†æ
- **è¿æ¥ç®¡ç†**: å®¢æˆ·ç«¯æ–­å¼€æ—¶è‡ªåŠ¨å…³é—­å¯¹åº”çš„æœåŠ¡å™¨è¿æ¥
- **æ¶ˆæ¯ç›‘æ§**: é€šè¿‡ InspectService è®°å½•æ—¶é—´æˆ³ã€æ–¹å‘ã€å†…å®¹ç­‰è¯¦ç»†ä¿¡æ¯

## API æ–‡æ¡£

### ä»£ç†ç«¯ç‚¹

æ‰€æœ‰ HTTP è¯·æ±‚éƒ½ä¼šè¢«ä»£ç†åˆ°ç›®æ ‡æœåŠ¡å™¨ï¼š

```
GET /api/*     -> ä»£ç†åˆ°ç›®æ ‡æœåŠ¡å™¨
POST /api/*    -> ä»£ç†åˆ°ç›®æ ‡æœåŠ¡å™¨
PUT /api/*     -> ä»£ç†åˆ°ç›®æ ‡æœåŠ¡å™¨
DELETE /api/*  -> ä»£ç†åˆ°ç›®æ ‡æœåŠ¡å™¨
```

### ç›‘æ§ç«¯ç‚¹

```bash
GET  /metrics          # è·å–æ€§èƒ½æŒ‡æ ‡
GET  /inspect/sse      # SSE å®æ—¶ç›‘æ§æµ
GET  /inspect/logs     # è·å–è¯·æ±‚æ—¥å¿—
```

### WebSocket è¿æ¥

```bash
ws://localhost:3000/ws  # WebSocket ç½‘å…³è¿æ¥ï¼ˆä¸€å¯¹ä¸€ä»£ç†æ¨¡å¼ï¼‰
```

### é™æ€èµ„æº

```bash
GET  /interspect/web/  # ç›‘æ§ä»ªè¡¨ç›˜ç•Œé¢
GET  /interspect/      # é‡å®šå‘åˆ° /interspect/web/
```

## å¼€å‘æŒ‡å—

### ä»£ç è§„èŒƒ

```bash
# ESLint æ£€æŸ¥å¹¶ä¿®å¤
npm run lint

# Prettier æ ¼å¼åŒ–
npm run format
```

### æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test

# ç›‘å¬æ¨¡å¼
npm run test:watch

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm run test:cov

# E2E æµ‹è¯•
npm run test:e2e
```

## ç›‘æ§ä»ªè¡¨ç›˜

è®¿é—® `http://localhost:3000/interspect/web/` æŸ¥çœ‹å®æ—¶ç›‘æ§ä»ªè¡¨ç›˜ï¼ŒåŒ…æ‹¬ï¼š

- è¯·æ±‚ç»Ÿè®¡å’Œæ€§èƒ½æŒ‡æ ‡
- å®æ—¶æ—¥å¿—æµ
- WebSocket è¿æ¥çŠ¶æ€
- ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ

### ä¸»è¦åŠŸèƒ½

- **å®æ—¶åè®®æµ**: é€šè¿‡ Server-Sent Events å®æ—¶æ¨é€ HTTP è¯·æ±‚/å“åº”å’Œ WebSocket æ¶ˆæ¯
- **æ™ºèƒ½æ—¥å¿—åˆ†æ**: æ”¯æŒæŒ‰è¯·æ±‚ç±»å‹ã€çŠ¶æ€ç ã€æ—¶é—´èŒƒå›´ç­‰æ¡ä»¶è¿‡æ»¤å’Œåˆ†æ
- **æ€§èƒ½å¯è§†åŒ–**: å®æ—¶å›¾è¡¨æ˜¾ç¤ºè¯·æ±‚é‡ã€å“åº”æ—¶é—´ã€è¿æ¥æ± çŠ¶æ€ç­‰å…³é”®æŒ‡æ ‡
- **åŒå‘æ¶ˆæ¯è¿½è¸ª**: æ¸…æ™°å±•ç¤º WebSocket æ¶ˆæ¯çš„å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨ã€æœåŠ¡å™¨åˆ°å®¢æˆ·ç«¯æµå‘
- **æ•°æ®æ ¼å¼æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«å¹¶æ ‡æ³¨æ–‡æœ¬å’ŒäºŒè¿›åˆ¶æ•°æ®ç±»å‹

## æ„å»ºå’Œéƒ¨ç½²

### æ„å»ºæµç¨‹

1. ç¼–è¯‘ TypeScript ä»£ç 
2. æ³¨å…¥ç‰ˆæœ¬ä¿¡æ¯
3. å¤åˆ¶é™æ€èµ„æº
4. è¾“å‡ºåˆ° `dist/` ç›®å½•

### Docker éƒ¨ç½²

```dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3000

CMD ["npm", "run", "start:prod"]
```

## ä½¿ç”¨åœºæ™¯

- **API è°ƒè¯•**: åœ¨å¼€å‘è¿‡ç¨‹ä¸­æˆªå–å’Œåˆ†æ API è¯·æ±‚/å“åº”
- **åè®®åˆ†æ**: æ·±å…¥ç†è§£ WebSocket é€šä¿¡åè®®å’Œæ•°æ®æ ¼å¼
- **æ€§èƒ½ç›‘æ§**: å®æ—¶ç›‘æ§ API å“åº”æ—¶é—´å’Œç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡
- **æ•…éšœæ’æŸ¥**: å¿«é€Ÿå®šä½ API è°ƒç”¨å¤±è´¥å’Œç½‘ç»œé—®é¢˜
- **å­¦ä¹ ç ”ç©¶**: åˆ†æ HTTP åè®®å’Œ WebSocket é€šä¿¡æœºåˆ¶

## è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. åˆ›å»º Pull Request

## è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤ Issue æˆ– Pull Requestã€‚